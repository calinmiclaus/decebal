NAME=kernel-server_ide
VERSION=2.6.11.10
ARCH=i686
RELEASE=1
URL="http://www.kernel.org/"
DESC="The Linux Kernel (GRSEC/PAX patches)."
GROUP=kernels
LICENSE="GPLv2"
SIZE="36368K"
HUSE="menuconfig xconfig"

SOURCES="http://www.kernel.org/pub/linux/kernel/v2.6/linux-2.6.11.tar.bz2
         http://www.kernel.org/pub/linux/kernel/v2.6/patch-2.6.11.10.bz2
	 http://grsecurity.net/grsecurity-2.1.5-2.6.11.9-200505121617.patch.gz
	 config-server_ide-$RELEASE"

RUNTIME="module-init-tools bootloader"	 

PROVIDES="kernel kernel-sources"
	 
build() {
  cd $SRC/linux-2.6.11
  
  remove_flags -fstack-protector -fstack-protector-all
  
  sed -i "s:\-EXTRAVERSION \= .9:\-EXTRAVERSION \= .10:" ../grsecurity-2.1.5-2.6.11.9-200505121617.patch
  sed -i "s:\+EXTRAVERSION \= .9-grsec:\+EXTRAVERSION \= .10-grsec:" ../grsecurity-2.1.5-2.6.11.9-200505121617.patch
  
  patch -p1 < ../patch-2.6.11.10
  patch -p1 < ../grsecurity-2.1.5-2.6.11.9-200505121617.patch
  
  sed -i "s:EXTRAVERSION \= .10-grsec:EXTRAVERSION \= .10-server-1:" Makefile
  
  mkdir -p $PKG/{boot,lib/modules}
  
  if use menuconfig
  then
    make menuconfig
  elif use xconfig
  then
    make xconfig
  else
    cp ../config-server_ide-$RELEASE ./.config
    yes "" | make config
  fi
  
  make clean
  make
  make INSTALL_MOD_PATH=$PKG modules_install
  
  install -m 0644 System.map $PKG/boot/System.map-server_ide-$VERSION-$RELEASE
  install -m 0644 arch/i386/boot/bzImage $PKG/boot/vmlinuz-server_ide-$VERSION-$RELEASE
  install -m 0644 .config $PKG/boot/config-server_ide-$VERSION-$RELEASE
  
  rdev -R $PKG/boot/vmlinuz-server_ide-$VERSION-$RELEASE 0
  rdev -v $PKG/boot/vmlinuz-server_ide-$VERSION-$RELEASE -1
  rdev -r $PKG/boot/vmlinuz-server_ide-$VERSION-$RELEASE 0
  
  rm -f $PKG/lib/modules/$VERSION-server-$RELEASE/{build,sources}
  ln -s /usr/src/linux-$VERSION-server_ide-$RELEASE $PKG/lib/modules/$VERSION-server-$RELEASE/build
  ln -s /usr/src/linux-$VERSION-server_ide-$RELEASE $PKG/lib/modules/$VERSION-server-$RELEASE/source
  
  mkdir -p $PKG/usr/src/linux-$VERSION-server_ide-$RELEASE/{include,arch/i386/kernel,.tmp_versions}
  for DIR in acpi asm-generic asm-i386 config linux math-emu media mtd net pcmcia rxrpc sound
  do
    cp -a include/$DIR $PKG/usr/src/linux-$VERSION-server_ide-$RELEASE/include/$DIR
  done
  
  cp -a scripts $PKG/usr/src/linux-$VERSION-server_ide-$RELEASE/
  cp arch/i386/Makefile $PKG/usr/src/linux-$VERSION-server_ide-$RELEASE/arch/i386/
  cp arch/i386/kernel/asm-offsets.s $PKG/usr/src/linux-$VERSION-server_ide-$RELEASE/arch/i386/kernel/
  
  for FILE in $(find ./ -type f -name "Kconfig*")
  do
    mkdir -p $PKG/usr/src/linux-$VERSION-server_ide-$RELEASE/${FILE%/*}
    cp $FILE $PKG/usr/src/linux-$VERSION-server_ide-$RELEASE/$FILE
  done
  
  ( cd $PKG/usr/src/linux-$VERSION-server_ide-$RELEASE/include; ln -s asm-i386 asm )
  
  install_docs COPYING CREDITS MAINTAINERS README REPORTING-BUGS
}
